---
layout: post
tags: fc reproduction mmc5 8mb tsop am29f080b
date: 2017-10-09 10:35
thumbnail: /blog/assets/images/posts/20171009/00.jpg
short: MMC5卡带1MB容量的改造
title: Legend of Link——MMC5卡带1MB容量的改造
issue_id: 13
categories: [FC]
published: true
---

MMC5是支持物理容量最大的mapper芯片，PRG和CHR分别最大支持1MByte（8mbit），这样和起来就是2Mbyte（8mbit）。不过可惜的是，FC时代容量最大的MMC5游戏金属荣光（Metal Slade Glory），也只是512KB+512KB（8mbit）的配置。所以除了制作合卡之外，没有1MB芯片的用处。

不过FC/NES时至今日仍然有着庞大的粉丝群体，其中一部分技术高人不断地琢磨着hack和改造游戏，从而诞生了千奇百怪的hack游戏版本。

其中一款比较优秀的就是Zelda - Legend of Link，这个版本基于元祖塞尔达改造，强化了画面、音乐，加入全新的道具和流程，变成了一个几乎全新的游戏。<br/>
[http://acmlm.kafuka.org/board/thread.php?id=7308](http://acmlm.kafuka.org/board/thread.php?id=7308)<br/>
[https://www.romhacking.net/hacks/2136/](https://www.romhacking.net/hacks/2136/)

<!--more-->

Legend of Link基于MMC5，容量到达了FC的极限：1MB PRG + 1MB CHR。

游戏中保留了塞尔达系列传统的3个存盘档位，要使这个三个存档都能正常工作还需要WRAM具备32KB的容量。纵观MMC5芯片的卡带PCB，只有EWROM天然符合这个条件。ETROM则可以替换WRAM芯片来升级到32KB，我打算等学会了芯片存档之后再研究这个。所以先就手头有的EWROM卡带开始改造。

![image](/blog/assets/images/posts/20171009/01.jpg)

![image](/blog/assets/images/posts/20171009/02.jpg)

![image](/blog/assets/images/posts/20171009/03.jpg)

用到EWROM的游戏只有三个：“元朝秘史”、“三国志II”、“武将风云录”。第一个已经属于珍稀卡带了，三国志2的现存数量也已经很少很少，好在武将风云录还比较好找，被我收了好几盘。

## ROM转接板
接下来就是找到合适的1MB容量的存储芯片，网上能找到的各类FC改造中用的比较多的是M27C801，这是EPROM芯片，需要进行紫外线擦除，所以不具备制成反复可烧录卡带的条件，并且我目前手头上也没有可以烧录EPROM的设备。所以最理想的方式还是使用Flash rom芯片，但32pin的Flash rom最大只支持512KB的容量，再往上的我也没有研究过是否有DIP封装的36pin或者40pin芯片，即使有的话卡带PCB也很难容纳。所以最优的方案就是使用TSOP封装40pin的Flash芯片（我买来的是AM29F080B）加TSOP to DIP的转接板的形式来解决。

转接板已经有很多人做出来了，但是我并没有发现有人分享过电路图，虽然我可以根据经验画一个图出来，但是个别针脚不是很确定。幸运的是我在网上找到了一篇同样是[制作Legend of Link的文章](https://jensma.de/?p=232&lang=en)，作者也设计了一个转接板。于是我通过邮件联系到他，他也很爽快地给我分享了转接板的电路图。但是这个转接板的设计是不兼容kazzo烧录的，所以我在它的基础之上做了一些修改，然后打样做出了自己的转接板。

![image](/blog/assets/images/posts/20171009/04.jpg)

板子的电路图可以从这里下载：[FlashAdapter](https://github.com/maximaas/Famicom-DIY/blob/master/repro/schematics/FlashAdapter)，下面是焊好了之前买好的AM29F080B芯片的样子：

![image](/blog/assets/images/posts/20171009/05.jpg)

这个转接板是适用于MMC5的针脚布局，如果需要在改造非MMC5的卡带上使用则需要调整一下设计，或者进行飞线处理。

## 改造和飞线

![image](/blog/assets/images/posts/20171009/06.png)

为了应对PRG和CHR上CE针脚的差异，转接板上设计了一个跳线。作为PRG使用时，WE和CE焊盘分别焊接到金手指的14pin和44pin。作为CHR使用时，WE连接到金手指的47pin，并且把CE和CHR的焊接连在一起。按照下图的方法进行飞线即可。

![image](/blog/assets/images/posts/20171009/07.png)

![image](/blog/assets/images/posts/20171009/08.jpg)

如上图所示，和ETROM类似，卡带金手指的14/44/47pin不需要直接焊到金手指触点上，在PCB上都可以找到对应这三个触点的焊盘。

转接板和卡带PCB的焊接需要用到排针，先把排针焊到卡带上对应的ROM位置，然后再把转接板也焊在排针上。

![image](/blog/assets/images/posts/20171009/09.jpg)

![image](/blog/assets/images/posts/20171009/10.jpg)

下面是芯片和飞线全部焊完之后的样子，同时也换上了新的电池座和电池。

![image](/blog/assets/images/posts/20171009/11.jpg)

![image](/blog/assets/images/posts/20171009/12.jpg)

卡带背面排针多出的部分可以不用剪掉，卡带外壳内部的空间刚好是可以容纳下的。

![image](/blog/assets/images/posts/20171009/13.jpg)

## 烧录
Kazzo的烧录脚本需要修改一下。首先是开头的"size_max"参数，需要修改为"8 * mega"，代表1MB大小。接着，这个脚本的ppu_transfer()函数实际有两个，第二个原本是被注释掉的，但是在这里需要启用第二个，而注释掉第一个。完整的脚本可以在文末下载。

![image](/blog/assets/images/posts/20171003/02.jpg)

所以我买来了所有的龙珠卡带（1代是动作游戏，制作质量也很一般，虽然我也买了，但是实在没啥动力去改造，所以本文中就忽略了），全部改造成烧录卡，然后把游戏都烧录成英文版。

先从[nescartdb](http://bootgod.dyndns.org:7777/)上查找卡带的信息：

| Game                           				    | Mapper | PCB                  |
|:--------------------------------------------------|:-------|:---------------------|
|Dragon Ball: Dai Maou Fukkatsu  					|16   	 |BANDAI-FCG-1          |
|Dragon Ball 3: Gokuu Den             			 	|16  	 |BANDAI-FCG-2          |
|Dragon Ball Z: Kyoushuu! Saiyajin          		|159	 |BANDAI-LZ93D50+24C01  |
|Dragon Ball Z II: Gekishin Freeza!!  				|16  	 |BANDAI-LZ93D50+24C02  |
|Dragon Ball Z III: Ressen Jinzou Ningen       		|16   	 |BANDAI-LZ93D50+24C02  |
|Dragon Ball Z Gaiden: Saiyajin Zetsumetsu Keikaku	|16  	 |BANDAI-LZ93D50+24C02  |

然后再寻找Bandai FCG mapper的相关信息：<br/>
[http://wiki.nesdev.com/w/index.php/Bandai_FCG_board](http://wiki.nesdev.com/w/index.php/Bandai_FCG_board)<br/>
[http://seesaawiki.jp/famicomcartridge/d/Bandai%20FCG-1](http://seesaawiki.jp/famicomcartridge/d/Bandai%20FCG-1)<br/>
[http://unagi.osdn.jp/cgi-bin/hiki/hiki.cgi?FCG-3](http://unagi.osdn.jp/cgi-bin/hiki/hiki.cgi?FCG-3)

接着又找到了韩国人改造FCG的blog：<br/>
[Mapper 16 : BANDAI FCG-1 / FCG-2 Flash Cartridge](http://blog.naver.com/PostView.nhn?blogId=xsnake&logNo=220357886147&categoryNo=29&parentCategoryNo=0&viewDate=&currentPage=2&postListTopCurrentPage=1&from=postView)<br/>
[Mapper 16 : FCG-3 : BANDAI LZ93D50 + 24C01 + 24C02](http://blog.naver.com/PostView.nhn?blogId=xsnake&logNo=220311282542&categoryNo=29&parentCategoryNo=0&viewDate=&currentPage=2&postListTopCurrentPage=1&from=postView)

以下的改造过程严重参考了上面两篇文章。

## 改造FCG-1/2

![image](/blog/assets/images/posts/20171003/03.jpg)

![image](/blog/assets/images/posts/20171003/04.jpg)

FCG-1和FCG-2芯片的针脚定义完全一样，几乎可认为是相同的芯片。从上面的图看出，区别就在于FCG-2的CHR是32pin（其他都是28pin）。所以两盘卡带的改造方法也是基本一样的。

![image](/blog/assets/images/posts/20171003/05.png)

按照上面的方法对PRG和CHR进行飞线。

其中PRG部分，这里需要用一个74HC14芯片来提供flash的OE#信号，按照图中显示的就是接线即可。

![image](/blog/assets/images/posts/20171003/06.jpg)

![image](/blog/assets/images/posts/20171003/07.jpg)

FCG-1的CHR是28pin，flash芯片的CE#要接地，而把OE#接到CHR /CE上。flash芯片会把PCB中间的孔洞遮挡住，所以在改造的最后还需要把外壳上凸起的圆柱切掉。

## 改造FCG-3

![image](/blog/assets/images/posts/20171003/08.jpg)

![image](/blog/assets/images/posts/20171003/09.jpg)

在FC时代，游戏存档通常都是靠卡带上的电池提供电能，用SRAM来存储的。而例外就是Bandai的这几盘带有24C01/24C02存储芯片的游戏，存档直接写入芯片，不需要电池。24C01和24C02区别只是在于存储容量，并不影响改造。

FCG-3的芯片型号是LZ93D50，所以通常称其对应的两种PCB为BANDAI-LZ93D50+24C01和BANDAI-LZ93D50+24C02.

![image](/blog/assets/images/posts/20171003/10.png)

FCG-3的PRG同样需要一个额外的芯片（74HC00）来提供OE#信号，这里要注意的一点是LZ93D50的16pin是连接到金手指的14pin的。从上面的电路图看出，74HC00以金手指14pin和M2的信号为输入，输出信号给PRG和LZ93D50。所以要把原本PCB上LZ93D50的16pin到14pin的通路截断，如下图所示：

![image](/blog/assets/images/posts/20171003/11.jpg)

FCG-1和2的烧录脚本是一致的，文末的附件中可以下载。

Z1强袭赛亚人的mapper编号是159，其实和mapper16是一样的，在Nestopia模拟器中查看rom信息也显示的就是mapper16。所以FCG3烧写游戏的脚本都是一样的，只是dump存档需要区分24C01或24C02芯片，因为容量不同逻辑也有区别，所以分成了两个脚本。

烧录好游戏，上机测试一下英文版的效果。

![image](/blog/assets/images/posts/20171003/12.jpg)

希望未来有人能接着把没做完的英化版完成，那么这个系列就完美了。


改造手册，用UltraEdit打开可以全屏不用翻页：[MMC5 - EWROM.txt](https://github.com/maximaas/Famicom-DIY/blob/master/repro/MMC5 - EWROM.txt)

烧录脚本：<br/>
[https://github.com/maximaas/Famicom-DIY/blob/master/repro/kazzo_scripts/mmc5_8mb.af](https://github.com/maximaas/Famicom-DIY/blob/master/repro/kazzo_scripts/mmc5_8mb.af)
